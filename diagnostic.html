<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Diagnostic Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Supabase Diagnostic Tool</h1>
    
    <div id="results"></div>
    
    <script>
        // Use the same credentials as in your supabaseService.js
        const supabaseUrl = 'https://jbmpfczuyspgxgqvejuf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpibXBmY3p1eXNwZ3hncXZlanVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NzI0NjUsImV4cCI6MjA4MjQ0ODQ2NX0.B-pyr_bsUYpU8eHAvBR-HWqj33ocEJw7EfCtFs8Meko';

        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        async function runDiagnostics() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>Running diagnostics...</h2>';

            try {
                // Test 1: Check if Supabase client is properly initialized
                resultsDiv.innerHTML += '<p>✅ Testing Supabase client initialization...</p>';
                
                // Test 2: Check if we can access auth status
                resultsDiv.innerHTML += '<p>✅ Testing auth status access...</p>';
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError && userError.message !== 'Auth session not found') {
                    resultsDiv.innerHTML += `<p style="color: red;">❌ Error accessing auth status: ${userError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += '<p>✅ Auth status accessible</p>';
                }

                // Test 3: Check if we can ping the Supabase instance
                resultsDiv.innerHTML += '<p>✅ Testing connection to Supabase...</p>';
                const { error: pingError } = await supabase.from('teachers').select('id').limit(1);
                if (pingError) {
                    resultsDiv.innerHTML += `<p>⚠️ Connection to Supabase established but teachers table may not exist: ${pingError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += '<p>✅ Connection to Supabase successful</p>';
                }

                // Test 4: Try to get current session to check auth state
                resultsDiv.innerHTML += '<p>✅ Testing current session...</p>';
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) {
                    resultsDiv.innerHTML += `<p style="color: orange;">⚠️ Session error: ${sessionError.message}</p>`;
                } else {
                    if (session) {
                        resultsDiv.innerHTML += '<p>✅ User is currently logged in</p>';
                    } else {
                        resultsDiv.innerHTML += '<p>✅ No user currently logged in (this is normal for initial state)</p>';
                    }
                }

                // Test 5: Check if we can access the auth settings by attempting a sign-in with invalid credentials
                resultsDiv.innerHTML += '<p>✅ Testing authentication endpoint...</p>';
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: 'test@example.com',
                        password: 'invalidpassword'
                    });
                    
                    if (error) {
                        resultsDiv.innerHTML += `<p>✅ Authentication endpoint is accessible (expected error for invalid credentials: ${error.message})</p>`;
                    } else {
                        resultsDiv.innerHTML += '<p>⚠️ Unexpected success with invalid credentials</p>';
                    }
                } catch (err) {
                    resultsDiv.innerHTML += `<p style="color: orange;">⚠️ Error testing auth endpoint: ${err.message}</p>`;
                }

                resultsDiv.innerHTML += '<h3>✅ Diagnostics completed</h3>';
                resultsDiv.innerHTML += '<p><strong>Next steps if you still have authentication timeout issues:</strong></p>';
                resultsDiv.innerHTML += '<ol>';
                resultsDiv.innerHTML += '<li>Go to your Supabase Dashboard</li>';
                resultsDiv.innerHTML += '<li>Navigate to Authentication > Settings</li>';
                resultsDiv.innerHTML += '<li>Ensure email authentication is enabled</li>';
                resultsDiv.innerHTML += '<li>Check that your site URL is added to "Redirect URLs" and "Site URLs"</li>';
                resultsDiv.innerHTML += '<li>Run the SQL commands from SETUP.md in the SQL Editor</li>';
                resultsDiv.innerHTML += '</ol>';

            } catch (error) {
                resultsDiv.innerHTML += `<p style="color: red;">❌ Error during diagnostics: ${error.message}</p>`;
            }
        }

        // Run diagnostics when page loads
        document.addEventListener('DOMContentLoaded', runDiagnostics);
    </script>
</body>
</html>